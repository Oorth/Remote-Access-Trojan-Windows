Microsoft (R) Macro Assembler (x64) Version 14.41.34123.0   02/08/25 15:17:42
debug_check.asm						     Page 1 - 1


				;ml64 /c /Fl debug_check.asm

				; Check if debugger is present by reading the PEB flag directly
				; Compatible with x64 architecture

 00000000			.code

 00000000			IsDebuggerPresentASM PROC
 00000000  65: 48/ 8B 04 25	    mov rax, gs:[60h]               ; Get PEB base address from GS:[0x60]
	   00000060
 00000009  8A 40 02		    mov al, byte ptr [rax+2]        ; Read BeingDebugged flag (offset 0x2)
 0000000C  C3			    ret
 0000000D			IsDebuggerPresentASM ENDP

				; DetectDebuggerTrapFlag PROC
				;     pushfq                      ; Push RFLAGS to stack
				;     or qword ptr [rsp], 0x100   ; Set Trap Flag (TF) in RFLAGS
				;     popfq                       ; Restore modified RFLAGS

				;     nop                         ; Executes normally if no debugger
				;     pushfq                      ; Push flags to check if TF triggered
				;     pop rax                     ; Retrieve flags

				;     test rax, 0x100             ; Check if Trap Flag was set
				;     setnz al                    ; AL = 1 if debugger is present
				;     movzx rax, al               ; Zero-extend AL to RAX for return

				;     ret
				; DetectDebuggerTrapFlag ENDP

 0000000D			DetectHardwareBreakpointsASM PROC
 0000000D  53			    push rbx                        ; Save registers to avoid corrupting them

 0000000E  0F 21 C0		    mov rax, dr0
 00000011  0F 21 CB		    mov rbx, dr1
 00000014  0F 21 D1		    mov rcx, dr2
 00000017  0F 21 DA		    mov rdx, dr3

 0000001A  48/ 0B C3		    or rax, rbx                     
 0000001D  48/ 0B C1		    or rax, rcx                     
 00000020  48/ 0B C2		    or rax, rdx

 00000023  0F 95 C0		    setnz al                        ; If reg set, AL = 1, else AL = 0
 00000026  48/ 0F B6 C0		    movzx rax, al                   ; Zero-extend AL to RAX

 0000002A  5B			    pop rbx                         
 0000002B			DetectHardwareBreakpointsASM ENDP

				END
Microsoft (R) Macro Assembler (x64) Version 14.41.34123.0   02/08/25 15:17:42
debug_check.asm						     Symbols 2 - 1




Procedures, parameters, and locals:

                N a m e                 Type     Value    Attr

DetectHardwareBreakpointsASM . .	P 	 0000000D _TEXT	Length= 0000001E Public
IsDebuggerPresentASM . . . . . .	P 	 00000000 _TEXT	Length= 0000000D Public

	   0 Warnings
	   0 Errors
